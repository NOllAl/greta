<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Example models</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/lumen.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="greta.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 54px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 59px;
  margin-top: -59px;
}

.section h2 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h3 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h4 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h5 {
  padding-top: 59px;
  margin-top: -59px;
}
.section h6 {
  padding-top: 59px;
  margin-top: -59px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">



<style type="text/css">
.logo {
    display: inline-block;
    width: 144px;
    height: 40px;
    background-image: url(banner-icon.png);
    background-size: 100% auto;
    background-repeat: no-repeat;
    vertical-align: middle;
}
</style>

<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="logo" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="get_started.html">get started</a>
        </li>
        <li>
          <a href="example_models.html">examples</a>
        </li>
        <li>
          <a href="reference-index.html">docs</a>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
            more
            <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" role="menu">
            <li>
              <a href="why_greta.html">why 'greta'?</a>
            </li>
            <li>
              <a href="technical_details.html">technical details</a>
            </li>
            <li>
              <a href="software.html">software</a>
            </li>
            <li>
              <a href="contribute.html">contribute to greta</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="https://github.com/greta-dev/greta">
            <span class="fa fa-github fa-lg"></span>
          </a>
        </li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Example models</h1>

</div>


<div id="common-models" class="section level2">
<h2>Common models</h2>
<p>Below are a few examples of common statistical models implemented in greta.</p>
<hr>
<div id="linear-regression" class="section level3">
<h3>Linear regression</h3>
<p>A simple, one-variable Bayesian linear regression model using the attitude data</p>
<pre class="r"><code># variables &amp; priors
int &lt;- normal(0, 10)
coef &lt;- normal(0, 10)
sd &lt;- cauchy(0, 3, truncation = c(0, Inf))

# linear predictor
mu &lt;- int + coef * attitude$complaints

# observation model
distribution(attitude$rating) &lt;- normal(mu, sd)</code></pre>
<hr>
</div>
<div id="multiple-linear-regression" class="section level3">
<h3>Multiple linear regression</h3>
<p>A multi-variable Bayesian linear regression model using the attitude data</p>
<pre class="r"><code># the predictors as a matrix
design &lt;- as.matrix(attitude[, 2:7])

int &lt;- normal(0, 10)
coefs &lt;- normal(0, 10, dim = ncol(design))
sd &lt;- cauchy(0, 3, truncation = c(0, Inf))

# matrix multiplication is more efficient than multiplying the coefficients
# separately
mu &lt;- int + design %*% coefs

distribution(attitude$rating) &lt;- normal(mu, sd)</code></pre>
<hr>
</div>
<div id="hierarchical-linear-regression" class="section level3">
<h3>Hierarchical linear regression</h3>
<p>A hierarchical, Bayesian linear regression model using the iris data, with random intercepts for each of the three species.</p>
<pre class="r"><code># linear model parameters
int &lt;- normal(0, 10)
coef &lt;- normal(0, 10)
sd &lt;- cauchy(0, 3, truncation = c(0, Inf))

# hierarchical model for species effect; use the first species as the baseline
# like in lm()
species_sd &lt;- lognormal(0, 1)
species_offset &lt;- normal(0, species_sd, dim = 2)
species_effect &lt;- rbind(0, species_offset)
species_id &lt;- as.numeric(iris$Species)

# model
mu &lt;- int + coef * iris$Sepal.Width + species_effect[species_id]
distribution(iris$Sepal.Length) &lt;- normal(mu, sd)</code></pre>
<hr>
</div>
</div>
<div id="bugs-models" class="section level2">
<h2>BUGS models</h2>
<p>The BUGS project provide a number of example models written in the BUGS modelling language. These models will run in WinBUGS and OpenBUGS, and likely also in JAGS. The <a href="https://github.com/stan-dev/example-models/wiki/BUGS-Examples-Sorted-Alphabetically">Stan wiki</a> provides Stan implementations of these models.</p>
<p>The following sections provide greta implementations of some of these example models, alongside the BUGS code from <a href="https://www.mrc-bsu.cam.ac.uk/wp-content/uploads/WinBUGS_Vol2.pdf">WinBUGS examples volume 2</a> (pdf) and Stan code and an R version of the data from the <a href="https://github.com/stan-dev/example-models/wiki">Stan example models wiki</a>.</p>
<hr>
<div id="air" class="section level3">
<h3>Air</h3>
<p><em>Air</em> analyses reported respiratory illness versus exposure to nitrogen dioxide in 103 children. The parameters <code>alpha</code>, <code>beta</code> and <code>sigma2</code> are known in advance, and the data are grouped into three categories.</p>
<p>See <a href="https://www.mrc-bsu.cam.ac.uk/wp-content/uploads/WinBUGS_Vol2.pdf">WinBUGS examples volume 2</a> (pdf) for details.</p>
<div id="data" class="section level4">
<h4>data</h4>
<div class="data">
<pre class="text"><code>y &lt;- c(21, 20, 15)
n &lt;- c(48, 34, 21)
Z &lt;- c(10, 30, 50)
alpha &lt;- 4.48
beta &lt;- 0.76
sigma2 &lt;- 81.14
sigma &lt;- sqrt(sigma2)
tau &lt;- 1 / sigma2
J &lt;- 3</code></pre>
</div>
</div>
<div id="greta-code" class="section level4">
<h4>greta code</h4>
<pre class="r"><code>theta &lt;- normal(0, 32, dim = 2)
mu &lt;- alpha + beta * Z
X &lt;- normal(mu, sigma)
p &lt;- ilogit(theta[1] + theta[2] * X)
distribution(y) &lt;- binomial(n, p)</code></pre>
</div>
<div id="bugsjags-code" class="section level4">
<h4>BUGS/JAGS code</h4>
<div class="bugs">
<pre><code>for(j in 1 : J) {
   y[j] ~ dbin(p[j], n[j])
   logit(p[j]) &lt;- theta[1] + theta[2] * X[j]
   X[j] ~ dnorm(mu[j], tau)
   mu[j] &lt;- alpha + beta * Z[j]
}
theta[1] ~ dnorm(0.0, 0.001)
theta[2] ~ dnorm(0.0, 0.001)</code></pre>
</div>
</div>
<div id="stan-code" class="section level4">
<h4>Stan code</h4>
<div class="stan">
<pre><code>data {
  real alpha; 
  real beta; 
  real&lt;lower=0&gt; sigma2; 
  int&lt;lower=0&gt; J; 
  int y[J]; 
  vector[J] Z;
  int n[J]; 
} 

transformed data {
  real&lt;lower=0&gt; sigma; 
  sigma &lt;- sqrt(sigma2); 
} 

parameters {
   real theta1; 
   real theta2; 
   vector[J] X; 
} 

model {
  real p[J];
  theta1 ~ normal(0, 32);   // 32^2 = 1024 
  theta2 ~ normal(0, 32); 
  X ~ normal(alpha + beta * Z, sigma);
  y ~ binomial_logit(n, theta1 + theta2 * X);
}</code></pre>
</div>
<hr>
</div>
</div>
<div id="beetles" class="section level3">
<h3>Beetles</h3>
<p><em>Beetles</em> considers dose-response data from an experiment applying carbon disulphide to 8 beetles. The original example compares three different link functions; the logit, probit and complementary log-log. Here, only the code for the logit link is shown. You can implement the other two link functions in greta by changing <code>ilogit</code> to <code>iprobit</code> or <code>icloglog</code>.</p>
<p>See <a href="https://www.mrc-bsu.cam.ac.uk/wp-content/uploads/WinBUGS_Vol2.pdf">WinBUGS examples volume 2</a> (pdf) for details.</p>
<div id="data-1" class="section level4">
<h4>data</h4>
<div class="data">
<pre class="text"><code>x &lt;- c(1.6907, 1.7242, 1.7552, 1.7842, 1.8113, 1.8369, 1.8610, 1.8839)
n &lt;- c(59, 60, 62, 56, 63, 59, 62, 60)
r &lt;- c(6, 13, 18, 28, 52, 53, 61, 60)
N &lt;- 8</code></pre>
</div>
</div>
<div id="greta-code-1" class="section level4">
<h4>greta code</h4>
<pre class="r"><code>alpha_star &lt;- normal(0, 32)
beta &lt;- normal(0, 32)
p &lt;- ilogit(alpha_star + beta * (x - mean(x)))
distribution(r) &lt;- binomial(n, p)

alpha &lt;- alpha_star - beta * mean(x)
rhat &lt;- p * n</code></pre>
</div>
<div id="bugsjags-code-1" class="section level4">
<h4>BUGS/JAGS code</h4>
<div class="bugs">
<pre><code>for( i in 1 : N ) {
  r[i] ~ dbin(p[i],n[i])
  logit(p[i]) &lt;- alpha.star + beta * (x[i] - mean(x[]))
  rhat[i] &lt;- n[i] * p[i]
  culmative.r[i] &lt;- culmative(r[i], r[i])
}
alpha &lt;- alpha.star - beta * mean(x[])
beta ~ dnorm(0.0,0.001)
alpha.star ~ dnorm(0.0,0.001)</code></pre>
</div>
</div>
<div id="stan-code-1" class="section level4">
<h4>Stan code</h4>
<div class="stan">
<pre><code>data {
    int&lt;lower=0&gt; N;
    int&lt;lower=0&gt; n[N];
    int&lt;lower=0&gt; r[N];
    vector[N] x;
}

transformed data {
    vector[N] centered_x;
    real mean_x;
    mean_x &lt;- mean(x);
    centered_x &lt;- x - mean_x;
}

parameters {
    real alpha_star;
    real beta;
}

transformed parameters {
    vector[N] m;
    m &lt;- alpha_star + beta * centered_x;
}

model {
  alpha_star ~ normal(0.0, 1.0E4);  
  beta ~ normal(0.0, 1.0E4);
  r ~ binomial_logit(n, m);
}

generated quantities {
  real alpha; 
  real p[N];
  real llike[N];
  real rhat[N];
  for (i in 1:N)  {
    p[i] &lt;- inv_logit(m[i]);
    llike[i]  &lt;- r[i]*log(p[i]) + (n[i]-r[i])*log(1-p[i]);  
    rhat[i] &lt;- p[i]*n[i];  // fitted values
  }
  alpha &lt;- alpha_star - beta*mean_x;              
} </code></pre>
</div>
<hr>
</div>
</div>
</div>
<div id="ecological-models" class="section level2">
<h2>Ecological models</h2>
<p>Here we provide some examples of common ecological models. We begin with a basic logistic regression often used in species distribution modelling to estimate species probability of presence. We then provide increasingly complex species distribution models, beginning with modelling obervation error directly, and moving on to models for multiple species: independentally but concurrently modelled species, partially pooled coefficients, repeated measures, and sub-models.</p>
<p>One important way <code>greta</code> models differs from BUGS and Stan code is that it is often neccessary to set up the linear predictor seperatly to the logistic transformation. This is particulary the case when the dimensions of the data increases, such as when there are multiple species being modelled. We keep this convention in the simpler models for ease of understanding.</p>
<hr>
<div id="logistic-regression" class="section level3">
<h3>Logistic regression</h3>
<p><em>Logistic regression</em> This is an example of a simple logistic regression being used to estimate the probability of species presence along a number of environmental gradients. We first simulate some data to model followed by the <code>greta</code> code.</p>
<div id="data-2" class="section level4">
<h4>data</h4>
<div class="data">
<pre class="text"><code># make fake data
n_env &lt;- 3
n_sites &lt;- 20

# n_sites x n_env matrix of environmental variables
env &lt;- matrix(rnorm(n_sites * n_env), nrow = n_sites) 
# n_sites observations of species presence or absence
occupancy &lt;- rbinom(n_sites, 1, 0.5) </code></pre>
</div>
</div>
<div id="greta-code-2" class="section level4">
<h4>greta code</h4>
<pre class="r"><code># load greta
library(greta)

# create matrices to greta arrays
X &lt;- as_data(env)
Y &lt;- as_data(occupancy)

# create greta arrays for random variables
alpha &lt;- normal(0, 10)
beta &lt;- normal(0, 10, dim = n_env)

# logit-linear model
linear_predictor &lt;- alpha + X %*% beta
p &lt;- ilogit(linear_predictor)

# distribution (likelihood) over observed values
distribution(Y) &lt;- bernoulli(p)</code></pre>
<hr>
</div>
</div>
<div id="poisson-regression" class="section level3">
<h3>Poisson regression</h3>
<p>An example of a simple poisson regression being used to estimate the abundance of a species along a number of environmental gradients. We first simulate some data to model followed by the <code>greta</code> code.</p>
<div id="data-3" class="section level4">
<h4>data</h4>
<div class="data">
<pre class="text"><code># make fake data
n_env &lt;- 3
n_sites &lt;- 20

# n_sites x n_env matrix of environmental variables
env &lt;- matrix(rnorm(n_sites * n_env), nrow = n_sites) 
# n_sites observations of species abundance
occupancy &lt;- rpois(n_sites, 5) </code></pre>
</div>
</div>
<div id="greta-code-3" class="section level4">
<h4>greta code</h4>
<pre class="r"><code># load greta
library(greta)

# create matrices to greta arrays
X &lt;- as_data(env)
Y &lt;- as_data(occupancy)

# create greta arrays for random variables
alpha &lt;- normal(0, 10)
beta &lt;- normal(0, 10, dim = n_env)

# model
linear_predictor &lt;- alpha + X %*% beta
lambda &lt;- log(linear_predictor)
distribution(Y) &lt;- poisson(lambda)</code></pre>
<hr>
</div>
</div>
<div id="logistic-regression-with-error-term" class="section level3">
<h3>Logistic regression with error term</h3>
<p><em>Logistic regression with observational error term</em> This is an example of a simple logistic regression with an extra observation-level error term We first simulate some data to model followed by the <code>greta</code> code.</p>
<div id="data-4" class="section level4">
<h4>data</h4>
<div class="data">
<pre class="text"><code># make fake data
n_env &lt;- 3
n_sites &lt;- 20

# n_sites x n_env matrix of environmental variables
env &lt;- matrix(rnorm(n_sites * n_env), nrow = n_sites) 
# n_sites observations of species presence or absence
occupancy &lt;- rbinom(n_sites, 1, 0.5)</code></pre>
</div>
</div>
<div id="greta-code-4" class="section level4">
<h4>greta code</h4>
<pre class="r"><code># load greta
library(greta)

# create matrices to greta arrays
X &lt;- as_data(env)
Y &lt;- as_data(occupancy)

# create greta arrays for random variables
alpha &lt;- normal(0, 10)
beta &lt;- normal(0, 10, dim = n_env)
error &lt;- normal(0, 10, dim = n_sites)

# logit-linear model with extra variation
linear_predictor &lt;- alpha + X %*% beta + error
p &lt;- ilogit(linear_predictor)

# distribution (likelihood) over observed values
distribution(Y) &lt;- bernoulli(p)</code></pre>
<hr>
</div>
</div>
<div id="multiple-species-modelling-independently-and-concurrently" class="section level3">
<h3>Multiple species modelling independently and concurrently</h3>
<p>An example of a logistic regression being used to estimate the probability of multiple species’ presences along a number of environmental gradients. Although modelled concurrently, the random variables for each species are independent. We first simulate some data to model followed by the <code>greta</code> code.</p>
<p>Where a single observation per species and location would have a bernoulli error distribution, multiple observations for each species and location have a binomial distribution. The small change in the code is commented below.</p>
<p>When modelling multiple species (or other grouping factor), we need an extra step in constructing the linear predictor. In order to add multiple <code>greta</code> arrays together <em>for each species</em> we can use the <code>sweep()</code> function.</p>
<div id="data-5" class="section level4">
<h4>data</h4>
<div class="data">
<pre class="text"><code># make fake data
n_species &lt;- 5
n_env &lt;- 3
n_sites &lt;- 20

env &lt;- matrix(rnorm(n_sites * n_env), nrow = n_sites)
occupancy &lt;- matrix(rbinom(n_species * n_sites, 1, 0.5), nrow = n_sites)</code></pre>
</div>
</div>
<div id="greta-code-5" class="section level4">
<h4>greta code</h4>
<pre class="r"><code># load greta
library(greta)

# create matrices to greta arrays
X &lt;- as_data(env)
Y &lt;- as_data(occupancy)

# variables
alpha &lt;- normal(0,10, dim = n_species)
beta &lt;- normal(0, 10, dim = c(n_env, n_species))

env_effect &lt;- X %*% beta

# matrix addition with `sweep()` create interim variable
linear_predictor &lt;- sweep(env_effect, 2, alpha, FUN = &#39;+&#39;)

# ilogit of linear predictor
p &lt;- ilogit(linear_predictor)

# a single observation means our data are bernoulli distributed
distribution(Y) &lt;- bernoulli(p)
# for n_obs repeat observations per species/location, we could use the binomial
# distribution:
# distribution(Y) &lt;- binomial(n_obs, p) </code></pre>
<hr>
</div>
</div>
<div id="multiple-species-with-partial-pooling-of-regression-coefficients" class="section level3">
<h3>Multiple species with partial pooling of regression coefficients</h3>
<p>An example of a logistic regression being used to estimate the probability of multiple species’ presences along a number of environmental gradients. Instead of assuming independence of species regression coefficients, we assume they are drawn from a shared distribution. We partially pool species responses. This gives us not ony the regression coefficients for each species but also a global average coefficient and a measure of variation between species responses to environmental gradients.</p>
<p>We first simulate some data to model followed by the <code>greta</code> code.</p>
<div id="data-6" class="section level4">
<h4>data</h4>
<div class="data">
<pre class="text"><code># make fake data
n_species &lt;- 5
n_env &lt;- 1
n_sites &lt;- 50

env &lt;- matrix(rnorm(n_sites * n_env), nrow = n_sites)
occupancy &lt;- matrix(rbinom(n_sites * n_species, 1, 0.5), nrow = n_sites)</code></pre>
</div>
</div>
<div id="greta-code-6" class="section level4">
<h4>greta code</h4>
<pre class="r"><code># load greta
library(greta)

# create matrices to greta arrays
X &lt;- as_data(env)
Y &lt;- as_data(occupancy)

# variables
global_alpha &lt;- normal(0, 10, dim = 1)
global_alpha_sd &lt;- uniform(0, 10, dim = 1) 
alpha &lt;- normal(global_alpha, global_alpha_sd, dim = n_species)

global_betas &lt;- normal(0, 10, dim = n_env)
global_betas_sd &lt;- uniform(0, 10, dim = n_env)
beta &lt;- normal(global_betas, global_betas_sd, dim = c(n_env, n_species))

env_effect &lt;- X %*% beta

# matrix addition with `sweep()` create interim variable
linear_predictor &lt;- sweep(env_effect, 2, alpha, FUN = &#39;+&#39;)

# ilogit of linear predictor
p &lt;- ilogit(linear_predictor)

# a single observation means our data are bernoulli distributed
distribution(Y) &lt;- bernoulli(p)</code></pre>
<hr>
</div>
</div>
<div id="multiple-species-with-sub-model-for-regression-coefficients" class="section level3">
<h3>Multiple species with sub-model for regression coefficients</h3>
<p>An example of a logistic regression being used to estimate the probability of multiple species’ presences along a number of environmental gradients. Instead of assuming independence of species regression coefficients, or partial pooling in shared distributions, we use a sub-model to estimate species regression coefficients. In this case, we’re using species traits to estimate their response to different environmental gradients.</p>
<p>Because we’re building a sub-model, it’s more efficient to simply add a coloumn of ones to dataframes for the base model and sub-model. This is simply to prevent our code from becoming too cumbersome. If we didn’t want to use our sub-model to estimate the intercept, we would not need to include the column of ones in the environmental dataframe.</p>
<p>We first simulate some data to model followed by the <code>greta</code> code.</p>
<div id="data-7" class="section level4">
<h4>data</h4>
<div class="data">
<pre class="text"><code># make fake data
n_species &lt;- 3
n_env &lt;- 1
n_sites &lt;- 5
n_traits &lt;- 1

# n_sites x n_env matrix of environmental variables
env &lt;- matrix(rnorm(n_sites * n_env), nrow = n_sites)
# n_species * n_traits matix of trait variables
traits &lt;- matrix(rnorm(n_species * n_traits), nrow = n_species)
# n_sites * n_species matrix of observed occupancy
occupancy &lt;- matrix(rbinom(n_sites * n_species, 1, 0.5), nrow = n_sites)</code></pre>
</div>
</div>
<div id="greta-code-7" class="section level4">
<h4>greta code</h4>
<pre class="r"><code># load greta
library(greta)

# data wrangling

# include a column of 1&#39;s for intercept estimation in the sub-model (traits) and base model
traits &lt;- cbind(rep(1, n_species), traits)
env &lt;- cbind(rep(1, n_sites), env)

# redefine the n_env and n_traits after adding in coloum of 1&#39;s for intercepts
n_env &lt;- ncol(env)
n_traits &lt;- ncol(traits)

# create matrices to greta arrays
X &lt;- as_data(env)
Y &lt;- as_data(occupancy)
U &lt;- as_data(traits)

# greta arrays for variables to be estimated
# sub-model parameters have normal prior distributions
g &lt;- normal(0, 10, dim = c(n_env, n_traits))
# parameters of the base model are a function of the parameters of the sub-model
beta &lt;-  g %*% t(U) 

# use the coefficients to get the model linear predictor
linear_predictor &lt;- X %*% beta 

# use the logit link to get probabilities of occupancy
p &lt;- ilogit(linear_predictor)

# data are bernoulli distributed
distribution(Y) &lt;- bernoulli(p)</code></pre>
<hr>
</div>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
